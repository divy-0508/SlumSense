<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resident Dashboard - Slumsense</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">Slum<span>sense</span></div>
        <ul class="sidebar-menu">
            <li><a href="#dashboard" onclick="showSection('dashboard')" class="active">üìä Dashboard</a></li>
            <li><a href="{{ url_for('index') }}">üó∫Ô∏è Interactive Map</a></li>
            <li><a href="#report" onclick="showSection('report')">üìù Report Problem</a></li>
            <li><a href="#mycomplaints" onclick="showSection('mycomplaints')">üìã My Complaints</a></li>
            <li><a href="#predictions" onclick="showSection('predictions')">üéØ Recommendation</a></li>
            <li><a href="#community" onclick="showSection('community')">üë• Community</a></li>
            <li><a href="#profile" onclick="showSection('profile')">‚öôÔ∏è Profile</a></li>
            <li><a href="#" onclick="logout()">üö™ Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="content-section">
            <div class="dashboard-header">
                <h1>Welcome, <span id="userName">Resident</span>!</h1>
                <p>Track your community issues and get AI-powered predictions</p>
            </div>

            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3>Total Complaints</h3>
                    <div class="card-value">12</div>
                </div>
                <div class="dashboard-card">
                    <h3>Resolved</h3>
                    <div class="card-value" style="color: var(--success);">8</div>
                </div>
                <div class="dashboard-card">
                    <h3>In Progress</h3>
                    <div class="card-value" style="color: var(--accent);">3</div>
                </div>
                <div class="dashboard-card">
                    <h3>Risk Alerts</h3>
                    <div class="card-value" style="color: var(--warning);">1</div>
                </div>
            </div>

            <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Recent Complaints</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Issue Type</th>
                            <th>Location</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="recentComplaintsBody">
                        <tr>
                            <td colspan="5" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Report Problem Section -->
        <div id="reportSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>Report a Problem</h1>
                <p>Help us keep your community safe and healthy</p>
            </div>

            <div class="form-section">
                <h2>Complaint Details</h2>
                
                <form onsubmit="handleComplaintSubmit(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="issueType">Issue Type *</label>
                            <select id="issueType" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem;" required>
                                <option value="">Select an issue</option>
                                <option value="water">üíß Water Storage Problem</option>
                                <option value="drainage">üöø Drainage Problem</option>
                                <option value="waste">üóëÔ∏è Waste Management</option>
                                <option value="other">‚ùì Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="severity">Severity Level *</label>
                            <select id="severity" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px; font-size: 1rem;" required>
                                <option value="">Select severity</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="location">Location *</label>
                        <input type="text" id="location" placeholder="Block/Area name" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Problem Description *</label>
                        <textarea id="description" placeholder="Describe the problem in detail..." rows="5" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="photo">Upload Photo (Optional)</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="photo" accept="image/*">
                            <label class="file-input-label">üì∑ Click to upload photo or drag & drop</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contact">Contact Number *</label>
                        <input type="tel" id="contact" placeholder="+91 XXXXX XXXXX" required>
                    </div>

                    <button type="submit" class="submit-btn">Submit Complaint</button>
                </form>
            </div>
        </div>

        <!-- My Complaints Section -->
        <div id="complaintsSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>My Complaints</h1>
                <p>View and track all your reported issues</p>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="cta-button" onclick="filterComplaints('all')" style="margin-right: 0.5rem; background: var(--secondary);">All</button>
                <button class="cta-button" onclick="filterComplaints('pending')" style="margin-right: 0.5rem; background: var(--warning);">Pending</button>
                <button class="cta-button" onclick="filterComplaints('inprogress')" style="margin-right: 0.5rem; background: var(--accent);">In Progress</button>
                <button class="cta-button" onclick="filterComplaints('resolved')" style="background: var(--success);">Resolved</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Issue Type</th>
                            <th>Location</th>
                            <th>Date Filed</th>
                            <th>Status</th>
                            <th>Prediction</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>üíß Water Storage</td>
                            <td>Block A</td>
                            <td>Dec 28, 2024</td>
                            <td><span class="status-badge status-resolved">Resolved</span></td>
                            <td>‚úì Risk Prevented</td>
                            <td><a href="#" style="color: var(--secondary); text-decoration: none;">Details</a></td>
                        </tr>
                        <tr>
                            <td>üöø Drainage</td>
                            <td>Block B</td>
                            <td>Dec 25, 2024</td>
                            <td><span class="status-badge status-inprogress">In Progress</span></td>
                            <td>‚ö†Ô∏è Medium Risk</td>
                            <td><a href="#" style="color: var(--secondary); text-decoration: none;">Details</a></td>
                        </tr>
                        <tr>
                            <td>üóëÔ∏è Waste</td>
                            <td>Block C</td>
                            <td>Dec 20, 2024</td>
                            <td><span class="status-badge status-pending">Pending</span></td>
                            <td>‚ö†Ô∏è High Risk</td>
                            <td><a href="#" style="color: var(--secondary); text-decoration: none;">Details</a></td>
                        </tr>
                        <tr>
                            <td>üíß Water Storage</td>
                            <td>Block D</td>
                            <td>Dec 15, 2024</td>
                            <td><span class="status-badge status-resolved">Resolved</span></td>
                            <td>‚úì Risk Prevented</td>
                            <td><a href="#" style="color: var(--secondary); text-decoration: none;">Details</a></td>
                        </tr>
                        <tr>
                            <td>üöø Drainage</td>
                            <td>Block A</td>
                            <td>Dec 10, 2024</td>
                            <td><span class="status-badge status-resolved">Resolved</span></td>
                            <td>‚úì Risk Prevented</td>
                            <td><a href="#" style="color: var(--secondary); text-decoration: none;">Details</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Predictions Section -->
        <div id="predictionsSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>Area Risk Predictions</h1>
                <p>AI-powered predictions for your area based on patterns and data</p>
            </div>

            <h2 style="margin-bottom: 1.5rem;">Current Risk Alerts for Your Area</h2>

            <div class="prediction-card">
                <h3>üíß Water Shortage Risk</h3>
                <p>Your area shows 72% probability of water shortage in the next 5 days</p>
                <p><strong>Recommendation:</strong> Encourage residents to stock water now. Authorities have been notified.</p>
                <span class="prediction-risk">HIGH RISK - Action Required</span>
            </div>

            <div class="prediction-card">
                <h3>üöø Flooding Risk (Post-Monsoon)</h3>
                <p>Drainage system efficiency is at 45%. With upcoming rains, flooding risk is 58%</p>
                <p><strong>Recommendation:</strong> Report any drainage blockages immediately. Clear standing water areas.</p>
                <span class="prediction-risk">MEDIUM RISK</span>
            </div>

            <div class="prediction-card">
                <h3>üóëÔ∏è Disease Outbreak Risk</h3>
                <p>Waste accumulation in Block B detected. Disease risk probability: 34%</p>
                <p><strong>Recommendation:</strong> Maintain clean surroundings. Regular waste collection scheduled for tomorrow.</p>
                <span class="prediction-risk">LOW RISK</span>
            </div>

            <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Historical Risk Patterns</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Issue Type</th>
                            <th>Frequency</th>
                            <th>Average Duration</th>
                            <th>Best Prevention</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>üíß Water Issues</td>
                            <td>Every 8-10 days</td>
                            <td>2-3 days</td>
                            <td>Scheduled maintenance</td>
                        </tr>
                        <tr>
                            <td>üöø Drainage</td>
                            <td>Every 15 days</td>
                            <td>1-2 days</td>
                            <td>Regular cleaning</td>
                        </tr>
                        <tr>
                            <td>üóëÔ∏è Waste</td>
                            <td>Daily</td>
                            <td>Varies</td>
                            <td>Frequent collection</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Community Section -->
        <div id="communitySection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>Community Updates</h1>
                <p>Latest news and updates from your area</p>
            </div>

            <div style="background: var(--text-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--success);">
                <h3 style="color: var(--success); margin-bottom: 0.5rem;">‚úì Water Tank Repaired - Block A</h3>
                <p>The water storage issue reported on Dec 28 has been resolved. Tank has been repaired and sanitized.</p>
                <small style="opacity: 0.6;">2 days ago</small>
            </div>

            <div style="background: var(--text-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--warning);">
                <h3 style="color: var(--warning); margin-bottom: 0.5rem;">‚ö†Ô∏è Drainage Work Ongoing - Block B</h3>
                <p>Government teams are working on the drainage system. Expected completion in 3 days.</p>
                <small style="opacity: 0.6;">1 day ago</small>
            </div>

            <div style="background: var(--text-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--accent);">
                <h3 style="color: var(--accent); margin-bottom: 0.5rem;">üì¢ Waste Collection Drive</h3>
                <p>Community cleanup drive scheduled for Sunday morning at 7 AM. All residents welcome!</p>
                <small style="opacity: 0.6;">5 days ago</small>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>My Profile</h1>
                <p>Update your information and preferences</p>
            </div>

            <div class="form-section">
                <h2>Personal Information</h2>
                <form onsubmit="handleProfileUpdate(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileName">Full Name</label>
                            <input type="text" id="profileName" value="Resident User" required>
                        </div>

                        <div class="form-group">
                            <label for="profilePhone">Mobile Number</label>
                            <input type="tel" id="profilePhone" value="+91 98765 43210" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="profileArea">Area/Slum</label>
                        <input type="text" id="profileArea" value="Block A, Slum 5" required>
                    </div>

                    <div class="form-group">
                        <label for="profileEmail">Email (Optional)</label>
                        <input type="email" id="profileEmail" placeholder="your.email@example.com">
                    </div>

                    <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Notification Preferences</h2>

                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="emailNotif" checked>
                        <label for="emailNotif" style="display: inline; margin-left: 0.5rem;">Email notifications for complaint updates</label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="smsNotif" checked>
                        <label for="smsNotif" style="display: inline; margin-left: 0.5rem;">SMS alerts for critical issues</label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="riskNotif" checked>
                        <label for="riskNotif" style="display: inline; margin-left: 0.5rem;">Notifications for predicted risks</label>
                    </div>

                    <button type="submit" class="submit-btn" style="margin-top: 1.5rem;">Save Changes</button>
                </form>
            </div>
        </div>

    </div>
</div>

<script>
    // Load user data
    window.addEventListener('DOMContentLoaded', function() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.type !== 'resident') {
            window.location.href = "{{ url_for('login') }}";
        }
        document.getElementById('userName').textContent = user.name || 'Resident';
        document.getElementById('profileName').value = user.name || '';
        document.getElementById('profilePhone').value = user.phone || '';
        document.getElementById('profileArea').value = user.area || '';

        loadMyComplaints();
    });

    async function handleComplaintSubmit(event) {
        event.preventDefault();
        const issueType = document.getElementById('issueType').value;
        const severity = document.getElementById('severity').value;
        const location = document.getElementById('location').value;
        const description = document.getElementById('description').value;
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!user.phone) {
            alert("User session invalid. Please login again.");
            return;
        }

        // For demo, we are mocking lat/lon since dashboard doesn't have a map picker yet.
        // Ideally, you'd pick a point on a map. We'll use a default or random nearby point.
        const mockLat = 28.61 + (Math.random() * 0.01); 
        const mockLon = 77.20 + (Math.random() * 0.01);

        try {
            const response = await fetch('/add_complaint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    lat: mockLat,
                    lon: mockLon,
                    city: user.area || 'Unknown',
                    category: issueType,
                    description: `${severity} Priority: ${description} (at ${location})`,
                    user_phone: user.phone
                })
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert(`Complaint submitted successfully!`);
                event.target.reset();
                showSection('mycomplaints');
                loadMyComplaints();
            } else {
                alert("Failed to submit complaint.");
            }
        } catch (error) {
            console.error(error);
            alert("Error submitting complaint.");
        }
    }

    async function loadMyComplaints() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.phone) return;

        try {
            const response = await fetch(`/api/user_complaints?phone=${user.phone}`);
            const complaints = await response.json();
            
            // Populate "My Complaints" Section
            const tbody = document.querySelector('#complaintsSection tbody');
            tbody.innerHTML = '';

            // Populate "Recent Complaints" Dashboard Widget
            const recentBody = document.getElementById('recentComplaintsBody');
            recentBody.innerHTML = '';

            if (complaints.length === 0) {
                const noDataHtml = '<tr><td colspan="6" style="text-align:center;">No complaints found.</td></tr>';
                tbody.innerHTML = noDataHtml;
                recentBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No recent activity.</td></tr>';
                return;
            }

            // Update Dashboard Counters
            const totalComplaints = complaints.length;
            const resolved = complaints.filter(c => c.status === 'Resolved').length;
            const inProgress = complaints.filter(c => c.status === 'In Progress').length;
            const pending = complaints.filter(c => c.status === 'Pending').length;

            // Assuming the cards are in order: Total, Resolved, In Progress, Alerts
            const cards = document.querySelectorAll('.dashboard-card .card-value');
            if(cards.length >= 3) {
                cards[0].textContent = totalComplaints;
                cards[1].textContent = resolved;
                cards[2].textContent = inProgress;
                // Risk alerts logic can remain separate or be integrated
            }

            // Populate Tables
            complaints.forEach((c, index) => {
                // Status Badge Helper
                const getStatusBadge = (status) => {
                    const s = status.toLowerCase().replace(' ', '');
                    return `<span class="status-badge status-${s}">${status}</span>`;
                };

                // Add to "My Complaints" (All)
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.category}</td>
                    <td>${c.location}</td>
                    <td>${c.date}</td>
                    <td>${getStatusBadge(c.status)}</td>
                    <td>‚ö†Ô∏è Analysis Pending</td>
                    <td><a href="#" style="color: var(--secondary);">Details</a></td>
                `;
                tbody.appendChild(tr);

                // Add to "Recent Complaints" (Top 3)
                if (index < 3) {
                    const trRecent = document.createElement('tr');
                    trRecent.innerHTML = `
                        <td>${c.category}</td>
                        <td>${c.location}</td>
                        <td>${c.date}</td>
                        <td>${getStatusBadge(c.status)}</td>
                        <td><a href="#" style="color: var(--secondary); text-decoration: none;">View</a></td>
                    `;
                    recentBody.appendChild(trRecent);
                }
            });

        } catch (error) {
            console.error("Error loading complaints:", error);
        }
    }

    function showSection(section) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(el => {
            el.style.display = 'none';
        });

        // Remove active class from all links
        document.querySelectorAll('.sidebar-menu a').forEach(el => {
            el.classList.remove('active');
        });

        // Show selected section
        const sectionMap = {
            'dashboard': 'dashboardSection',
            'report': 'reportSection',
            'mycomplaints': 'complaintsSection',
            'predictions': 'predictionsSection',
            'community': 'communitySection',
            'profile': 'profileSection'
        };

        const sectionId = sectionMap[section];
        if (sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }

        // Add active class
        if (event && event.target) {
            event.target.classList.add('active');
        }
    }

    function handleProfileUpdate(event) {
        event.preventDefault();
        alert('Profile updated successfully!');
    }

    function filterComplaints(status) {
        alert('Filtering complaints by: ' + status);
    }

    function logout() {
        localStorage.removeItem('user');
        window.location.href = "{{ url_for('home') }}";
    }

    // Make showSection work with onclick
    document.addEventListener('click', function(event) {
        if (event.target.getAttribute('onclick') && event.target.getAttribute('onclick').startsWith('showSection')) {
            event.preventDefault();
        }
    });
</script>

</body>
</html>
