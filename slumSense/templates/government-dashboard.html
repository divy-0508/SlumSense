<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Dashboard - Slumsense</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- Analytics JS -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
    <style>
        .analytics-controls {
            margin-bottom: 20px;
        }
        .analytics-select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 16px;
            background: white;
            color: var(--text-dark);
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .analytics-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
            border-left: 4px solid var(--secondary);
        }
        .analytics-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .analytics-chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            height: 350px;
            width: 100%;
        }
        /* Override dashboard.js card class for compatibility */
        #metricCards .card {
            background: white !important;
            color: var(--text-dark) !important;
            border: 1px solid var(--border) !important;
            border-left: 4px solid var(--secondary) !important;
            border-radius: 8px !important;
            padding: 15px !important;
            margin: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
            display: block !important;
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">Slum<span>sense</span></div>
        <ul class="sidebar-menu">
            <li><a href="#dashboard" onclick="showSection('dashboard')" class="active">üìä Dashboard</a></li>
            <li><a href="{{ url_for('index') }}">üî• Live Hotspots Map</a></li>
            <li><a href="#complaints" onclick="showSection('complaints')">üìã All Complaints</a></li>
            <li><a href="#analytics" onclick="showSection('analytics')">üìà Analytics</a></li>
            <li><a href="#predictions" onclick="showSection('predictions')">üéØ Risk Predictions</a></li>
            <li><a href="#areas" onclick="showSection('areas')">üó∫Ô∏è Area Management</a></li>
            <li><a href="#team" onclick="showSection('team')">üë• Team</a></li>
            <li><a href="#settings" onclick="showSection('settings')">‚öôÔ∏è Settings</a></li>
            <li><a href="#" onclick="logout()">üö™ Logout</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="content-section">
            <div class="dashboard-header">
                <h1>Government Portal</h1>
                <p>Monitor, manage, and resolve community issues</p>
            </div>

            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3>Total Complaints</h3>
                    <div class="card-value">156</div>
                </div>
                <div class="dashboard-card">
                    <h3>Resolved</h3>
                    <div class="card-value" style="color: var(--success);">98</div>
                </div>
                <div class="dashboard-card">
                    <h3>In Progress</h3>
                    <div class="card-value" style="color: var(--accent);">42</div>
                </div>
                <div class="dashboard-card">
                    <h3>Critical Alerts</h3>
                    <div class="card-value" style="color: var(--danger);">5</div>
                </div>
            </div>

            <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Complaint Priority Queue</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Issue Type</th>
                            <th>Location</th>
                            <th>Resident</th>
                            <th>Date</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="priorityQueueBody">
                        <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Complaints Section -->
        <div id="complaintsSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>All Complaints</h1>
                <p>View and manage community complaints</p>
            </div>

            <div style="margin-bottom: 2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <input type="text" id="searchComplaints" placeholder="Search by location or ID..." style="flex: 1; min-width: 200px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                <select id="filterStatus" style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="inprogress">In Progress</option>
                    <option value="resolved">Resolved</option>
                </select>
                <select id="filterIssue" style="padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                    <option value="">All Issues</option>
                    <option value="water">Water</option>
                    <option value="drainage">Drainage</option>
                    <option value="waste">Waste</option>
                </select>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Resident</th>
                            <th>Date</th>
                            <th>Days Open</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="allComplaintsBody">
                        <tr><td colspan="9" style="text-align:center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>City Analytics</h1>
                <p>Real-time data visualization and trends</p>
            </div>

            <div class="analytics-controls">
                <label for="citySelect" style="margin-right: 10px; font-weight: bold;">Select City:</label>
                <select id="citySelect" class="analytics-select" style="margin-right: 20px;">
                    {% if cities %}
                        {% for c in cities %}
                            <option value="{{ c }}">{{ c }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="">No Data Available</option>
                    {% endif %}
                </select>

                <label for="categorySelect" style="margin-right: 10px; font-weight: bold;">Select Category:</label>
                <select id="categorySelect" class="analytics-select">
                    <option value="water">üíß Water</option>
                    <option value="drainage">üöø Drainage</option>
                    <option value="electricity">‚ö° Electricity</option>
                    <option value="sanitation">üßπ Sanitation</option>
                </select>
            </div>

            <div id="metricCards" class="analytics-grid"></div>

            <div class="analytics-chart-container">
                <div id="mainChart" style="width: 100%; height: 100%;"></div>
            </div>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="analytics-chart-container" style="flex: 1; min-width: 400px;">
                    <div id="chart2" style="width: 100%; height: 100%;"></div>
                </div>
                <div class="analytics-chart-container" style="flex: 1; min-width: 400px;">
                    <div id="chart3" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Risk Predictions Section -->
        <div id="predictionsSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>AI Risk Predictions</h1>
                <p>Machine learning-based predictions for preventive action</p>
            </div>

            <div class="analytics-card" style="margin-bottom: 2rem; border-left: 4px solid var(--primary);">
                <h2> Water Equity Forecast </h2>
                <p>Simulate scenarios to predict water stress index.</p>
                
                <form onsubmit="handleRiskPrediction(event)" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-top: 1rem;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="predictCity">City</label>
                        <select id="predictCity" class="analytics-select" style="width: 100%;" required>
                            {% if cities %}
                                {% for c in cities %}
                                    <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">No Data</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="predictDate">Date</label>
                        <input type="date" id="predictDate" class="analytics-select" style="width: 100%;" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="predictWater">Available Water (KL)</label>
                        <input type="number" id="predictWater" class="analytics-select" style="width: 100%;" placeholder="e.g. 5000" step="any" required>
                    </div>

                    <button type="submit" class="submit-btn" style="width: auto; padding: 10px 20px;">Predict Risk</button>
                </form>

                <div id="predictionResult" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; display: none;">
                    <h3>Prediction Result:</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">
                        <span id="riskScore">--</span> 
                        <span style="font-size: 1rem; color: #666; font-weight: normal;">Required Water(KL)</span>
                    </div>
                    <p id="riskContext" style="margin-top: 0.5rem;"></p>
                </div>
            </div>

            <div class="analytics-card" style="margin-bottom: 2rem; border-left: 4px solid var(--danger);">
                <h2> Water Stress Index Forecast </h2>
                <p>Predict water stress levels based on environmental factors.</p>
                
                <form onsubmit="handleStressPrediction(event)" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-top: 1rem;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="stressCity">City</label>
                        <select id="stressCity" class="analytics-select" style="width: 100%;" required>
                            {% if cities %}
                                {% for c in cities %}
                                    <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">No Data</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="stressDate">Date</label>
                        <input type="date" id="stressDate" class="analytics-select" style="width: 100%;" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="stressWater">Available Water (KL)</label>
                        <input type="number" id="stressWater" class="analytics-select" style="width: 100%;" placeholder="e.g. 5000" step="any" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="stressHours">Avg Supply (Hrs)</label>
                        <input type="number" id="stressHours" class="analytics-select" style="width: 100%;" placeholder="e.g. 4.5" step="0.1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="stressTemp">Temp (¬∞C)</label>
                        <input type="number" id="stressTemp" class="analytics-select" style="width: 100%;" placeholder="e.g. 32" step="0.1" required>
                    </div>

                    <button type="submit" class="submit-btn" style="width: auto; padding: 10px 20px;">Predict Stress</button>
                </form>

                <div id="stressResult" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; display: none;">
                    <h3>Prediction Result:</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--danger);">
                        <span id="stressScore">--</span> 
                        <span style="font-size: 1rem; color: #666; font-weight: normal;">(0-1 Index)</span>
                    </div>
                    <p id="stressContext" style="margin-top: 0.5rem;"></p>
                </div>
            </div>

            <div class="analytics-card" style="margin-bottom: 2rem; border-left: 4px solid var(--accent);">
                <h2>üóëÔ∏è Daily Garbage Generated Forecast </h2>
                <p>Predict daily garbage generation based on available resources.</p>
                
                <form onsubmit="handleGarbagePrediction(event)" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-top: 1rem;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="garbageCity">City</label>
                        <select id="garbageCity" class="analytics-select" style="width: 100%;" required>
                            {% if cities %}
                                {% for c in cities %}
                                    <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">No Data</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="garbageDate">Date</label>
                        <input type="date" id="garbageDate" class="analytics-select" style="width: 100%;" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="garbageVehicles">Vehicles Available</label>
                        <input type="number" id="garbageVehicles" class="analytics-select" style="width: 100%;" placeholder="e.g. 15" step="1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="garbageBins">Bins Available</label>
                        <input type="number" id="garbageBins" class="analytics-select" style="width: 100%;" placeholder="e.g. 120" step="1" required>
                    </div>

                    <button type="submit" class="submit-btn" style="width: auto; padding: 10px 20px;">Predict Garbage</button>
                </form>

                <div id="garbageResult" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; display: none;">
                    <h3>Prediction Result:</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--accent);">
                        <span id="garbageScore">--</span> 
                        <span style="font-size: 1rem; color: #666; font-weight: normal;">(Metric Tons)</span>
                    </div>
                    <p id="garbageContext" style="margin-top: 0.5rem;"></p>
                </div>
            </div>

            <div class="analytics-card" style="margin-bottom: 2rem; border-left: 4px solid #8e44ad;">
                <h2>üöÆ Overflowing Bins Forecast </h2>
                <p>Predict the number of overflowing bins based on resources and complaints.</p>
                
                <form onsubmit="handleOverflowPrediction(event)" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-top: 1rem;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="overflowCity">City</label>
                        <select id="overflowCity" class="analytics-select" style="width: 100%;" required>
                            {% if cities %}
                                {% for c in cities %}
                                    <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">No Data</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="overflowDate">Date</label>
                        <input type="date" id="overflowDate" class="analytics-select" style="width: 100%;" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="overflowVehicles">Vehicles Available</label>
                        <input type="number" id="overflowVehicles" class="analytics-select" style="width: 100%;" placeholder="e.g. 15" step="1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="overflowBins">Bins Available</label>
                        <input type="number" id="overflowBins" class="analytics-select" style="width: 100%;" placeholder="e.g. 120" step="1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="overflowComplaints">Garbage Complaints</label>
                        <input type="number" id="overflowComplaints" class="analytics-select" style="width: 100%;" placeholder="e.g. 5" step="1" required>
                    </div>

                    <button type="submit" class="submit-btn" style="width: auto; padding: 10px 20px;">Predict Overflow</button>
                </form>

                <div id="overflowResult" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; display: none;">
                    <h3>Prediction Result:</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #8e44ad;">
                        <span id="overflowScore">--</span> 
                        <span style="font-size: 1rem; color: #666; font-weight: normal;">(Bins)</span>
                    </div>
                    <p id="overflowContext" style="margin-top: 0.5rem;"></p>
                </div>
            </div>

            <div class="analytics-card" style="margin-bottom: 2rem; border-left: 4px solid #c0392b;">
                <h2>‚ö†Ô∏è Overflow Risk Score Forecast </h2>
                <p>Predict the risk score of garbage overflow events.</p>
                
                <form onsubmit="handleRiskScorePrediction(event)" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; margin-top: 1rem;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="riskCity">City</label>
                        <select id="riskCity" class="analytics-select" style="width: 100%;" required>
                            {% if cities %}
                                {% for c in cities %}
                                    <option value="{{ c }}">{{ c }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">No Data</option>
                            {% endif %}
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="riskDate">Date</label>
                        <input type="date" id="riskDate" class="analytics-select" style="width: 100%;" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="riskVehicles">Vehicles Available</label>
                        <input type="number" id="riskVehicles" class="analytics-select" style="width: 100%;" placeholder="e.g. 15" step="1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="riskBins">Bins Available</label>
                        <input type="number" id="riskBins" class="analytics-select" style="width: 100%;" placeholder="e.g. 120" step="1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="riskComplaints">Garbage Complaints</label>
                        <input type="number" id="riskComplaints" class="analytics-select" style="width: 100%;" placeholder="e.g. 5" step="1" required>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="riskCollected">Garbage Collected (Kg)</label>
                        <input type="number" id="riskCollected" class="analytics-select" style="width: 100%;" placeholder="e.g. 5000" step="10" required>
                    </div>

                    <button type="submit" class="submit-btn" style="width: auto; padding: 10px 20px;">Predict Risk Score</button>
                </form>

                <div id="riskScoreResult" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; display: none;">
                    <h3>Prediction Result:</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: #c0392b;">
                        <span id="riskScoreValue">--</span> 
                        <span style="font-size: 1rem; color: #666; font-weight: normal;">(Risk Score)</span>
                    </div>
                    <p id="riskScoreContext" style="margin-top: 0.5rem;"></p>
                </div>
            </div>

            <h2 style="margin-bottom: 1.5rem;">Critical Risk Alerts - Action Required</h2>

            <div class="prediction-card">
                <h3>üö® CRITICAL: Water Shortage - Block A</h3>
                <p><strong>Probability: 85%</strong> | Timeline: Next 3-5 days</p>
                <p>Pattern Analysis: Water tank repairs were incomplete. Similar issues occurred 15, 30, and 45 days ago.</p>
                <p><strong>Recommended Action:</strong> Deploy maintenance team immediately. Issue water conservation advisory.</p>
                <button class="cta-button" style="margin-top: 1rem;">Assign Team</button>
            </div>

            <div class="prediction-card">
                <h3>‚ö†Ô∏è HIGH: Disease Outbreak Risk - Block C</h3>
                <p><strong>Probability: 72%</strong> | Timeline: 5-10 days</p>
                <p>Contributing Factors: Waste accumulation (8 days), Poor drainage (ongoing), Humidity: 78%</p>
                <p><strong>Recommended Action:</strong> Schedule immediate waste collection. Deploy health awareness team.</p>
                <button class="cta-button" style="margin-top: 1rem;">Deploy Health Team</button>
            </div>
        </div>

        <!-- Area Management Section -->
        <div id="areasSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>Area Management</h1>
                <p>Oversee all slum areas under jurisdiction</p>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Area</th>
                            <th>Population</th>
                            <th>Complaints</th>
                            <th>Open Issues</th>
                            <th>Risk Level</th>
                            <th>Last Updated</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Block A, Slum 5</td>
                            <td>2,450</td>
                            <td>28</td>
                            <td>8</td>
                            <td><span class="status-badge status-pending" style="background: rgba(243, 156, 18, 0.2); color: var(--warning);">HIGH</span></td>
                            <td>2 hours ago</td>
                            <td><a href="#" style="color: var(--secondary);">Monitor</a></td>
                        </tr>
                        <tr>
                            <td>Block B, Slum 5</td>
                            <td>1,890</td>
                            <td>22</td>
                            <td>6</td>
                            <td><span class="status-badge status-pending" style="background: rgba(243, 156, 18, 0.2); color: var(--warning);">HIGH</span></td>
                            <td>1 hour ago</td>
                            <td><a href="#" style="color: var(--secondary);">Monitor</a></td>
                        </tr>
                        <tr>
                            <td>Block C, Slum 5</td>
                            <td>1,620</td>
                            <td>18</td>
                            <td>4</td>
                            <td><span class="status-badge status-pending" style="background: rgba(52, 152, 219, 0.2); color: var(--accent);">MEDIUM</span></td>
                            <td>30 mins ago</td>
                            <td><a href="#" style="color: var(--secondary);">Monitor</a></td>
                        </tr>
                        <tr>
                            <td>Block D, Slum 6</td>
                            <td>1,230</td>
                            <td>12</td>
                            <td>2</td>
                            <td><span class="status-badge status-pending" style="background: rgba(52, 152, 219, 0.2); color: var(--accent);">MEDIUM</span></td>
                            <td>45 mins ago</td>
                            <td><a href="#" style="color: var(--secondary);">Monitor</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Team Section -->
        <div id="teamSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>Team Management</h1>
                <p>Manage field teams and task assignments</p>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="cta-button">+ Add Team Member</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Area Assigned</th>
                            <th>Tasks Today</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Amit Kumar</td>
                            <td>Field Supervisor</td>
                            <td>Block A, Slum 5</td>
                            <td>5</td>
                            <td><span style="color: var(--success); font-weight: 600;">Active</span></td>
                            <td><a href="#" style="color: var(--secondary);">Assign</a></td>
                        </tr>
                        <tr>
                            <td>Priya Sharma</td>
                            <td>Maintenance Tech</td>
                            <td>Block B, Slum 5</td>
                            <td>3</td>
                            <td><span style="color: var(--success); font-weight: 600;">Active</span></td>
                            <td><a href="#" style="color: var(--secondary);">Assign</a></td>
                        </tr>
                        <tr>
                            <td>Rajesh Singh</td>
                            <td>Sanitation Manager</td>
                            <td>Block C, Slum 5</td>
                            <td>4</td>
                            <td><span style="color: var(--success); font-weight: 600;">Active</span></td>
                            <td><a href="#" style="color: var(--secondary);">Assign</a></td>
                        </tr>
                        <tr>
                            <td>Deepak Verma</td>
                            <td>Health Officer</td>
                            <td>All Areas</td>
                            <td>6</td>
                            <td><span style="color: var(--accent); font-weight: 600;">On Call</span></td>
                            <td><a href="#" style="color: var(--secondary);">Contact</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="content-section" style="display: none;">
            <div class="dashboard-header">
                <h1>Portal Settings</h1>
                <p>Configure system and notification preferences</p>
            </div>

            <div class="form-section">
                <h2>Notification Alerts</h2>
                <form onsubmit="handleSettingsSave(event)">
                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="criticalAlert" checked>
                        <label for="criticalAlert" style="display: inline; margin-left: 0.5rem;"><strong>Critical Issues</strong> - Instant email & SMS</label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="predictAlert" checked>
                        <label for="predictAlert" style="display: inline; margin-left: 0.5rem;"><strong>Risk Predictions</strong> - Daily digest</label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <input type="checkbox" id="dailyReport" checked>
                        <label for="dailyReport" style="display: inline; margin-left: 0.5rem;"><strong>Daily Report</strong> - Every morning at 8 AM</label>
                    </div>

                    <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Complaint Auto-Assignment</h2>

                    <div class="form-group">
                        <label for="autoAssign">Auto-assign complaints based on area</label>
                        <select id="autoAssign" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 6px;">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>

                    <h2 style="margin-top: 2rem; margin-bottom: 1rem;">Data & Backup</h2>

                    <div style="margin-bottom: 1rem;">
                        <button type="button" class="cta-button">Export Data</button>
                        <button type="button" class="cta-button" style="margin-left: 0.5rem; background: var(--accent);">Download Backup</button>
                    </div>

                    <button type="submit" class="submit-btn">Save Settings</button>
                </form>
            </div>
        </div>

    </div>
</div>

<script>
    // Load user data
    window.addEventListener('DOMContentLoaded', function() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.type !== 'government') {
            window.location.href = "{{ url_for('login') }}";
        }
        loadAllComplaints();
    });

    async function loadAllComplaints() {
        try {
            const response = await fetch('/api/all_complaints');
            const complaints = await response.json();
            
            const priorityBody = document.getElementById('priorityQueueBody');
            const allBody = document.getElementById('allComplaintsBody');
            
            priorityBody.innerHTML = '';
            allBody.innerHTML = '';
            
            if (complaints.length === 0) {
                const noData = '<tr><td colspan="8" style="text-align:center;">No complaints found.</td></tr>';
                priorityBody.innerHTML = noData;
                allBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No complaints found.</td></tr>';
                
                // Update dashboard counters
                updateCounters(0, 0, 0, 0);
                return;
            }

            // Calculate stats
            const total = complaints.length;
            const resolved = complaints.filter(c => c.status === 'Resolved').length;
            const inProgress = complaints.filter(c => c.status === 'In Progress').length;
            const pending = complaints.filter(c => c.status === 'Pending').length;
            
            updateCounters(total, resolved, inProgress, pending);

            complaints.forEach(c => {
                // Priority Logic (Mock) - Randomize or derive for demo
                // In real app, this would come from backend
                const priorities = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
                const priority = priorities[Math.floor(Math.random() * priorities.length)]; 
                
                let priorityStyle = '';
                if (priority === 'CRITICAL') priorityStyle = 'background: rgba(231, 76, 60, 0.2); color: var(--danger);';
                else if (priority === 'HIGH') priorityStyle = 'background: rgba(243, 156, 18, 0.2); color: var(--warning);';
                else if (priority === 'MEDIUM') priorityStyle = 'background: rgba(52, 152, 219, 0.2); color: var(--accent);';
                else priorityStyle = 'background: rgba(46, 204, 113, 0.2); color: var(--success);';

                const statusBadge = `<span class="status-badge status-${c.status.toLowerCase().replace(' ','')}">${c.status}</span>`;
                const priorityBadge = `<span style="${priorityStyle} padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${priority}</span>`;

                // Add to Priority Queue (Top 5 for demo)
                if (priorityBody.children.length < 5) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${c.id}</td>
                        <td>${c.category}</td>
                        <td>${c.city || c.location}</td>
                        <td>${c.user_phone || 'Anonymous'}</td>
                        <td>${c.date}</td>
                        <td>${priorityBadge}</td>
                        <td>${statusBadge}</td>
                        <td><a href="#" style="color: var(--secondary); text-decoration: none;">Manage</a></td>
                    `;
                    priorityBody.appendChild(tr);
                }

                // Add to All Complaints
                const trAll = document.createElement('tr');
                trAll.innerHTML = `
                    <td>#${c.id}</td>
                    <td>${c.category}</td>
                    <td>${c.city || c.location}</td>
                    <td>${c.user_phone || 'Anonymous'}</td>
                    <td>${c.date}</td>
                    <td>${Math.floor(Math.random() * 10)}</td> <!-- Mock Days Open -->
                    <td>${statusBadge}</td>
                    <td>${priorityBadge}</td>
                    <td><a href="#" style="color: var(--secondary); cursor: pointer;" onclick="openComplaintDetail()">Manage</a></td>
                `;
                allBody.appendChild(trAll);
            });

            // Analytics Logic
            updateAnalytics(complaints);

        } catch (error) {
            console.error("Error loading complaints:", error);
        }
    }

    function updateAnalytics(complaints) {
        // Issue Distribution
        const issueCounts = {};
        complaints.forEach(c => {
            if (!issueCounts[c.category]) {
                issueCounts[c.category] = { total: 0, resolved: 0, pending: 0 };
            }
            issueCounts[c.category].total++;
            if (c.status === 'Resolved') issueCounts[c.category].resolved++;
            else issueCounts[c.category].pending++;
        });

        const issueBody = document.getElementById('issueDistributionBody');
        issueBody.innerHTML = '';
        const totalComplaints = complaints.length;

        for (const [category, stats] of Object.entries(issueCounts)) {
            const tr = document.createElement('tr');
            const percent = ((stats.total / totalComplaints) * 100).toFixed(1);
            tr.innerHTML = `
                <td>${category}</td>
                <td>${stats.total}</td>
                <td>${stats.resolved}</td>
                <td>${stats.pending}</td>
                <td>${percent}%</td>
            `;
            issueBody.appendChild(tr);
        }

        // Top Problem Areas
        const areaCounts = {};
        complaints.forEach(c => {
            const area = c.city || 'Unknown Area';
            if (!areaCounts[area]) {
                areaCounts[area] = { total: 0, categories: {} };
            }
            areaCounts[area].total++;
            areaCounts[area].categories[c.category] = (areaCounts[area].categories[c.category] || 0) + 1;
        });

        const areaBody = document.getElementById('problemAreasBody');
        areaBody.innerHTML = '';

        // Sort by total issues desc
        const sortedAreas = Object.entries(areaCounts).sort((a, b) => b[1].total - a[1].total).slice(0, 5);

        sortedAreas.forEach(([area, stats]) => {
            // Find most common category
            const mostCommon = Object.entries(stats.categories).sort((a, b) => b[1] - a[1])[0][0];
            
            // Risk Level based on count (Arbitrary logic for demo)
            let riskHtml = '';
            if (stats.total > 10) riskHtml = '<span class="status-badge status-pending" style="background: rgba(231, 76, 60, 0.2); color: var(--danger);">CRITICAL</span>';
            else if (stats.total > 5) riskHtml = '<span class="status-badge status-pending" style="background: rgba(243, 156, 18, 0.2); color: var(--warning);">HIGH</span>';
            else riskHtml = '<span class="status-badge status-pending" style="background: rgba(52, 152, 219, 0.2); color: var(--accent);">MEDIUM</span>';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${area}</td>
                <td>${stats.total}</td>
                <td>${mostCommon}</td>
                <td>${riskHtml}</td>
            `;
            areaBody.appendChild(tr);
        });
    }

    function updateCounters(total, resolved, inProgress, critical) {
        // Assuming cards are in order: Total, Resolved, In Progress, Critical
        const cards = document.querySelectorAll('.dashboard-card .card-value');
        if(cards.length >= 4) {
            cards[0].textContent = total;
            cards[1].textContent = resolved;
            cards[2].textContent = inProgress;
            cards[3].textContent = critical; // Using pending as proxy for critical/alerts in this basic implementation
        }
    }

    function showSection(section) {
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(el => {
            el.style.display = 'none';
        });

        // Remove active class from all links
        document.querySelectorAll('.sidebar-menu a').forEach(el => {
            el.classList.remove('active');
        });

        // Show selected section
        const sectionMap = {
            'dashboard': 'dashboardSection',
            'complaints': 'complaintsSection',
            'analytics': 'analyticsSection',
            'predictions': 'predictionsSection',
            'areas': 'areasSection',
            'team': 'teamSection',
            'settings': 'settingsSection'
        };

        const sectionId = sectionMap[section];
        if (sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }

        // Add active class
        if (event && event.target) {
            event.target.classList.add('active');
        }
    }

    function openComplaintDetail() {
        alert('Opening complaint details and assignment interface...');
    }

    function handleSettingsSave(event) {
        event.preventDefault();
        alert('Settings saved successfully!');
    }

    function logout() {
        localStorage.removeItem('user');
        window.location.href = "{{ url_for('home') }}";
    }

    async function handleRiskPrediction(event) {
        event.preventDefault();
        
        const city = document.getElementById('predictCity').value;
        const date = document.getElementById('predictDate').value;
        const water = document.getElementById('predictWater').value;
        const resultDiv = document.getElementById('predictionResult');
        const scoreSpan = document.getElementById('riskScore');
        const contextP = document.getElementById('riskContext');

        if(!city || !date || !water) {
            alert("Please fill all fields");
            return;
        }

        scoreSpan.textContent = "Loading...";
        resultDiv.style.display = 'block';
        contextP.textContent = "";

        try {
            const response = await fetch('/api/predict_risk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city: city, date: date, available_water: water })
            });

            const data = await response.json();

            if (data.error) {
                scoreSpan.textContent = "Error";
                contextP.textContent = data.error;
                contextP.style.color = "red";
            } else {
                const score = parseFloat(data.prediction).toFixed(3);
                scoreSpan.textContent = score;
                
                // Interpret score
                let riskLevel = "Low";
                let color = "green";
                if (score > 0.7) { riskLevel = "Critical"; color = "red"; }
                else if (score > 0.5) { riskLevel = "High"; color = "orange"; }
                else if (score > 0.3) { riskLevel = "Medium"; color = "#f39c12"; }

                contextP.innerHTML = `Risk Level: <strong style="color: ${color}">${riskLevel}</strong><br>Forecast for ${data.inputs.date}`;
                contextP.style.color = "var(--text-dark)";
            }
        } catch (error) {
            console.error(error);
            scoreSpan.textContent = "Error";
            contextP.textContent = "Failed to connect to prediction service.";
        }
    }

    async function handleStressPrediction(event) {
        event.preventDefault();
        
        const city = document.getElementById('stressCity').value;
        const date = document.getElementById('stressDate').value;
        const water = document.getElementById('stressWater').value;
        const hours = document.getElementById('stressHours').value;
        const temp = document.getElementById('stressTemp').value;
        
        const resultDiv = document.getElementById('stressResult');
        const scoreSpan = document.getElementById('stressScore');
        const contextP = document.getElementById('stressContext');

        if(!city || !date || !water || !hours || !temp) {
            alert("Please fill all fields");
            return;
        }

        scoreSpan.textContent = "Loading...";
        resultDiv.style.display = 'block';
        contextP.textContent = "";

        try {
            const response = await fetch('/api/predict_stress', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    city: city, 
                    date: date, 
                    available_water: water,
                    avg_supply_hours: hours,
                    temperature: temp
                })
            });

            const data = await response.json();

            if (data.error) {
                scoreSpan.textContent = "Error";
                contextP.textContent = data.error;
                contextP.style.color = "red";
            } else {
                const score = parseFloat(data.prediction).toFixed(3);
                scoreSpan.textContent = score;
                
                // Interpret score (Stress Index usually 0-1 or similar)
                let status = "Normal";
                let color = "green";
                if (score > 0.7) { status = "High Stress"; color = "red"; }
                else if (score > 0.4) { status = "Moderate Stress"; color = "orange"; }

                contextP.innerHTML = `Status: <strong style="color: ${color}">${status}</strong>`;
                contextP.style.color = "var(--text-dark)";
            }
        } catch (error) {
            console.error(error);
            scoreSpan.textContent = "Error";
            contextP.textContent = "Failed to connect to prediction service.";
        }
    }

    async function handleGarbagePrediction(event) {
        event.preventDefault();
        
        const city = document.getElementById('garbageCity').value;
        const date = document.getElementById('garbageDate').value;
        const vehicles = document.getElementById('garbageVehicles').value;
        const bins = document.getElementById('garbageBins').value;
        
        const resultDiv = document.getElementById('garbageResult');
        const scoreSpan = document.getElementById('garbageScore');
        const contextP = document.getElementById('garbageContext');

        if(!city || !date || !vehicles || !bins) {
            alert("Please fill all fields");
            return;
        }

        scoreSpan.textContent = "Loading...";
        resultDiv.style.display = 'block';
        contextP.textContent = "";

        try {
            const response = await fetch('/api/predict_garbage', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    city: city, 
                    date: date, 
                    vehicles: vehicles,
                    bins: bins
                })
            });

            const data = await response.json();

            if (data.error) {
                scoreSpan.textContent = "Error";
                contextP.textContent = data.error;
                contextP.style.color = "red";
            } else {
                const score = parseFloat(data.prediction).toFixed(2);
                scoreSpan.textContent = score;
                
                contextP.innerHTML = `Forecast for ${data.inputs.date}`;
                contextP.style.color = "var(--text-dark)";
            }
        } catch (error) {
            console.error(error);
            scoreSpan.textContent = "Error";
            contextP.textContent = "Failed to connect to prediction service.";
        }
    }

    async function handleOverflowPrediction(event) {
        event.preventDefault();
        
        const city = document.getElementById('overflowCity').value;
        const date = document.getElementById('overflowDate').value;
        const vehicles = document.getElementById('overflowVehicles').value;
        const bins = document.getElementById('overflowBins').value;
        const complaints = document.getElementById('overflowComplaints').value;
        
        const resultDiv = document.getElementById('overflowResult');
        const scoreSpan = document.getElementById('overflowScore');
        const contextP = document.getElementById('overflowContext');

        if(!city || !date || !vehicles || !bins || !complaints) {
            alert("Please fill all fields");
            return;
        }

        scoreSpan.textContent = "Loading...";
        resultDiv.style.display = 'block';
        contextP.textContent = "";

        try {
            const response = await fetch('/api/predict_overflowing_bins', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    city: city, 
                    date: date, 
                    vehicles: vehicles,
                    bins: bins,
                    complaints: complaints
                })
            });

            const data = await response.json();

            if (data.error) {
                scoreSpan.textContent = "Error";
                contextP.textContent = data.error;
                contextP.style.color = "red";
            } else {
                const score = parseFloat(data.prediction).toFixed(0);
                scoreSpan.textContent = score;
                
                contextP.innerHTML = `Forecast for ${data.inputs.date}`;
                contextP.style.color = "var(--text-dark)";
            }
        } catch (error) {
            console.error(error);
            scoreSpan.textContent = "Error";
            contextP.textContent = "Failed to connect to prediction service.";
        }
    }

    async function handleRiskScorePrediction(event) {
        event.preventDefault();
        
        const city = document.getElementById('riskCity').value;
        const date = document.getElementById('riskDate').value;
        const vehicles = document.getElementById('riskVehicles').value;
        const bins = document.getElementById('riskBins').value;
        const complaints = document.getElementById('riskComplaints').value;
        const collected = document.getElementById('riskCollected').value;
        
        const resultDiv = document.getElementById('riskScoreResult');
        const scoreSpan = document.getElementById('riskScoreValue');
        const contextP = document.getElementById('riskScoreContext');

        if(!city || !date || !vehicles || !bins || !complaints || !collected) {
            alert("Please fill all fields");
            return;
        }

        scoreSpan.textContent = "Loading...";
        resultDiv.style.display = 'block';
        contextP.textContent = "";

        try {
            const response = await fetch('/api/predict_risk_score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    city: city, 
                    date: date, 
                    vehicles: vehicles,
                    bins: bins,
                    complaints: complaints,
                    garbage_collected: collected
                })
            });

            const data = await response.json();

            if (data.error) {
                scoreSpan.textContent = "Error";
                contextP.textContent = data.error;
                contextP.style.color = "red";
            } else {
                const score = parseFloat(data.prediction).toFixed(2);
                scoreSpan.textContent = score;
                
                let riskLevel = "Low";
                let color = "green";
                if (score > 70) { riskLevel = "Critical"; color = "red"; }
                else if (score > 40) { riskLevel = "Moderate"; color = "orange"; }

                contextP.innerHTML = `Risk Level: <strong style="color: ${color}">${riskLevel}</strong><br>Forecast for ${data.inputs.date}`;
                contextP.style.color = "var(--text-dark)";
            }
        } catch (error) {
            console.error(error);
            scoreSpan.textContent = "Error";
            contextP.textContent = "Failed to connect to prediction service.";
        }
    }
</script>

</body>
</html>
